<!DOCTYPE html>
<html>
    <head>
        <title>midterm</title>
        <meta name="description" content="midterm for Jamie's web 3 class">
        <link rel="stylesheet" type="text/css" href="css/main.css"/>
    </head>
    <body>
        <input id="siteInput" type="text" contenteditable></input>
        <button id="btn" onclick="">go</button>
        <div id="main-container"></div>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/tween.min.js"></script>
        <script src="js/TrackballControls.js"></script>
        <script src="js/CSS3DRenderer.js"></script>

    	<script type="text/javascript">
            var siteLink;
            loadPage('http://www.moma.org/');
            var btn = document.getElementById('btn');

            btn.addEventListener('click',function(evt) {
                siteLink = document.getElementById('siteInput').value;
                evt.preventDefault();
                evt.stopPropagation();
                $('#main-container').html('');
                loadPage(siteLink);
            });

            function loadPage(siteLink){
                $.getJSON('http://whateverorigin.org/get?url=' + encodeURIComponent(siteLink) + '&callback=?',
                    function(data){
                        var scripts = $(data.contents).filter('script');
                        var links = $(data.contents).filter('link');
                        var divs = $(data.contents).find('div');
                        var imgs = $(data.contents).find('img');
                        var atags = $(data.contents).find('a');

                        for( var i = 0; i < divs.length; i++ ){
                            if( divs[i].querySelector('script') ){
                                divs[i].querySelector('script').remove();
                            }
                        }

                        //---------------------remove the last slash of the input URL ----------------------
                        var lastChar = siteLink.substr(-1);
                        if (lastChar == '/') {   
                            siteLink = siteLink.substring(0, siteLink.length-1);
                        }

                        //-----------------------check if the source failed-------------------------------
                        for(var i = 0; i < links.length; i ++){
                            var url = links[i].getAttribute('href');
                            if( url.substring(0,2) == '//' ){
                                url = 'http:' + url;
                                links[i].setAttribute('href',url);
                                //console.log(links[i]);
                            } else
                            if( url.substring(0,4) != 'http' ){
                                url = siteLink + url;
                                links[i].setAttribute('href',url);
                                //console.log(links[i]);
                            }
                            $('#main-container').append(links[i]);
                        }

                        for(var i = 0; i < imgs.length; i ++){
                            var url = imgs[i].getAttribute('src');
                            if( url.substring(0,2) == '//' ){
                                url = 'http:' + url;
                                imgs[i].setAttribute('src',url);
                            }else
                            if( url.substring(0,4) != 'http' ){
                                url = siteLink + url;
                                imgs[i].setAttribute('src',url);
                            }
                            $('#main-container').append(imgs[i]);
                        }

                        for(var i = 0; i < atags.length; i ++){
                            var url = atags[i].getAttribute('href');
                            console.log(url);
                            //var check = url.indexOf('#');
                            //console.log(check);
                            if( url != null ){
                                if( url.substring(0) != '#'){
                                    if( url.substring(0,2) == '//' ){
                                        url = 'http:' + url;
                                        atags[i].setAttribute('href',url);
                                    }else
                                    if( url.substring(0,4) != 'http' ){
                                        url = siteLink + url;
                                        atags[i].setAttribute('href',url);
                                    }
                                }
                            }

                            if( atags[i].querySelector('img') ){
                                var img = atags[i].querySelector('img');
                                var url = img.getAttribute('src');
                                if( url.substring(0,2) == '//' ){
                                    url = 'http:' + url;
                                    img.setAttribute('src',url);
                                }else
                                if( url.substring(0,4) != 'http' ){
                                    url = siteLink + url;
                                    console.log(url);
                                    img.setAttribute('src',url);
                                }
                                $('#main-container').append(atags[i].img);
                            }
                        }

                        // for(var i = 0; i < scripts.length; i ++){
                        //     if( scripts[i].hasAttribute('src') > 0 ){
                        //         var url = scripts[i].getAttribute('src');
                        //         if( url.substring(0,2) == '//' ){
                        //             url = 'http:' + url;
                        //             scripts[i].setAttribute('src',url);
                        //         }else
                        //         if( url.substring(0,4) != 'http' ){
                        //             url = siteLink + url;
                        //             scripts[i].setAttribute('src',url);
                        //         }
                        //     }
                        //     $('#main-container').append(scripts[i]);
                        // }
                        //----------------------------end of checking----------------------------------

                        for(var i = 0; i < divs.length; i++){
                            $(divs[i]).css({'float':'left'});
                        }
                        $('#main-container').append(divs);
                    }
                );
            }   

            // $.ajax({
            //     url: 'proxy.php',
            //     type: 'POST',
            //     data: {
            //         address: 'http://www.google.com/'
            //     },
            //     success: function(res) {
            //         console.log('this is cool!');

            //         var headline = $(res.responseText);
            //         console.log(headline);
            //     }
            // });

            // $.ajax({
            //    type: 'GET',
            //    url: "http://www.google.com/",
            //    processData: true,
            //    data: {},
            //    dataType: "json",
            //    success: function (data) {
            //        processData(data);
            //    }
            // });
             
            // function processData(data){
            //     //console.log(data);
            // }


    	</script>
        <script type="text/javascript" src="js/script.js"></script>
    </body>
</html>
		